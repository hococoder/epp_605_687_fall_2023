<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Mobile Application Development for the iOS Platform"/><link rel="canonical" href="https://hococoder.com/posts/Week06/03-CoreImageFaceDetectionExample"/><meta name="twitter:url" content="https://hococoder.com/posts/Week06/03-CoreImageFaceDetectionExample"/><meta name="og:url" content="https://hococoder.com/posts/Week06/03-CoreImageFaceDetectionExample"/><title>Week 6 - Core Image Face Detection Example | Mobile Application Development for the iOS Platform</title><meta name="twitter:title" content="Week 6 - Core Image Face Detection Example | Mobile Application Development for the iOS Platform"/><meta name="og:title" content="Week 6 - Core Image Face Detection Example | Mobile Application Development for the iOS Platform"/><meta name="description" content="A description of my first post."/><meta name="twitter:description" content="A description of my first post."/><meta name="og:description" content="A description of my first post."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><link rel="stylesheet" href="../../../styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Mobile Application Development for the iOS Platform"/></head><body><header><div class="wrapper"><a class="site-name" href="/">Mobile Application Development for the iOS Platform</a><nav><ul><li><a href="/epp_605_687_spring_2023/posts/Intro/About Me">AboutMe</a></li><li><a href="/epp_605_687_spring_2023/posts/Intro/Example App">ExampleApp</a></li><li><a href="/epp_605_687_spring_2023/posts/Week00/00-Week00Overview">Week0</a></li><li><a href="/epp_605_687_spring_2023/posts/Week01/00-Week01Overview">Week1</a></li><li><a href="/epp_605_687_spring_2023/posts/Week02/00-Week02Overview">Week2</a></li><li><a href="/epp_605_687_spring_2023/posts/Week03/00-Week03Overview">Week3</a></li><li><a href="/epp_605_687_spring_2023/posts/Week04/00-Week04Overview">Week4</a></li><li><a href="/epp_605_687_spring_2023/posts/Week05/00-Week05Overview">Week5</a></li><li><a href="/epp_605_687_spring_2023/posts/Week06/00-Week06Overview">Week6</a></li><li><a href="/epp_605_687_spring_2023/posts/Week07/00-Week07Overview">Week7</a></li><li><a href="/epp_605_687_spring_2023/posts/Week08/00-Week08Overview">Week8</a></li><li><a href="/epp_605_687_spring_2023/posts/Week09/00-Week09Overview">Week9</a></li><li><a href="/epp_605_687_spring_2023/posts/Week10/00-Week10Overview">Week10</a></li><li><a href="/epp_605_687_spring_2023/posts/Week11/00-Week11Overview">Week11</a></li><li><a href="/epp_605_687_spring_2023/posts/Week12/00-Week12Overview">Week12</a></li><li><a href="/epp_605_687_spring_2023/posts/Week13/00-Week13Overview">Week13</a></li><li><a href="/epp_605_687_spring_2023/posts/Week14/00-Week14Overview">Week14</a></li></ul></nav></div></header><div class="wrapper"><h1>Week 6 - Core Image Face Detection Example</h1><p style="float: left">Previous:  <A HREF="../02-CoreImageFiltersExample/index.html">Core Image Filters Example</A></p><p style="float: right">Next:  <A HREF="../04-MakingCustomControlsWithSwiftUI/index.html" class="nextModule">Making Custom Controls with SwiftUI</A></p><BR/><BR/><center> <iframe width="1280" height="720" src="https://cdnapisec.kaltura.com/html5/html5lib/v2.81.2/mwEmbedFrame.php/p/1458241/uiconf_id/14487351/entry_id/1_chwkefgd?wid=_1458241&iframeembed=true&playerId=kaltura_player&entry_id=1_chwkefgd&flashvars[localizationCode]=en&amp;flashvars[leadWithHTML5]=true&amp;flashvars[sideBarContainer.plugin]=true&amp;flashvars[sideBarContainer.position]=left&amp;flashvars[sideBarContainer.clickToClose]=true&amp;flashvars[chapters.plugin]=true&amp;flashvars[chapters.layout]=vertical&amp;flashvars[chapters.thumbnailRotator]=false&amp;flashvars[streamSelector.plugin]=true&amp;flashvars[EmbedPlayer.SpinnerTarget]=videoHolder&amp;flashvars[dualScreen.plugin]=true&amp;flashvars[mediaProxy.preferedFlavorBR]=2500&amp;flashvars[Kaltura.addCrossoriginToIframe]=true&amp;flashvars[EmbedPlayer.NotPlayableDownloadLink]=true;&wid=1_abkvs1gz"allowfullscreen webkitallowfullscreen mozAllowFullScreen allow="autoplay *; fullscreen *; encrypted-media *" sandbox="allow-forms allow-same-origin allow-scripts allow-top-navigation allow-pointer-lock allow-popups allow-modals allow-orientation-lock allow-popups-to-escape-sandbox allow-presentation allow-top-navigation-by-user-activation" frameborder="0" title="Kaltura Player">
  </iframe>
</center><p>Let's extend on the last example, and add functionality to detect faces. I started by adding in some <code>@State</code> properties to track - letting us monitor the position and size of the rectangles that we'll use to highlight the face and eyes, and the rectangles themselves.</p><pre><code><span class="keyword">@State var</span> faceRectangle: <span class="type">Rectangle</span>?
<span class="keyword">@State var</span> faceRectangleWidth: <span class="type">CGFloat</span> = <span class="number">0</span>
<span class="keyword">@State var</span> faceRectangleHeight: <span class="type">CGFloat</span> = <span class="number">0</span>
<span class="keyword">@State var</span> faceRectangleOrigin: <span class="type">CGPoint</span> = <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">0</span>)

<span class="keyword">@State var</span> leftEyeRectangle: <span class="type">Rectangle</span>?
<span class="keyword">@State var</span> leftEyeRectangleWidth: <span class="type">CGFloat</span> = <span class="number">0</span>
<span class="keyword">@State var</span> leftEyeRectangleHeight: <span class="type">CGFloat</span> = <span class="number">0</span>
<span class="keyword">@State var</span> leftEyeRectangleOrigin: <span class="type">CGPoint</span> = <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">0</span>)

<span class="keyword">@State var</span> rightEyeRectangle: <span class="type">Rectangle</span>?
<span class="keyword">@State var</span> rightEyeRectangleWidth: <span class="type">CGFloat</span> = <span class="number">0</span>
<span class="keyword">@State var</span> rightEyeRectangleHeight: <span class="type">CGFloat</span> = <span class="number">0</span>
<span class="keyword">@State var</span> rightEyeRectangleOrigin: <span class="type">CGPoint</span> = <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">0</span>)
</code></pre><p>In the body view, place the image in a <code>ZStack</code> (with leading horizontal alignment and top vertical alignment), and add in the left eye, right eye, and face rectangles, giving them all clear fills, red borders of width 1, and defining their frame with the appropriate width, height and origin properties. Note here that the origin is the CENTER of the rectangle, not a corner like <code>CGRect</code> from <code>CoreGraphics</code> usually defines it. The body should now look like this:</p><pre><code><span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {
  
  <span class="type">VStack</span>(alignment: .<span class="dotAccess">center</span>) {
    <span class="type">HStack</span> {
      <span class="type">ZStack</span>(alignment: <span class="type">Alignment</span>(horizontal: .<span class="dotAccess">leading</span>, vertical: .<span class="dotAccess">top</span>)){
        image
        faceRectangle?.<span class="call">fill</span>(<span class="type">Color</span>.<span class="property">clear</span>).<span class="call">border</span>(<span class="type">Color</span>.<span class="property">red</span>, width: <span class="comment">/*@START_MENU_TOKEN@*/</span><span class="number">1</span><span class="comment">/*@END_MENU_TOKEN@*/</span>).<span class="call">frame</span>(width: faceRectangleWidth, height: faceRectangleHeight).<span class="call">position</span>(faceRectangleOrigin)
        leftEyeRectangle?.<span class="call">fill</span>(<span class="type">Color</span>.<span class="property">clear</span>).<span class="call">border</span>(<span class="type">Color</span>.<span class="property">red</span>, width: <span class="number">1</span>).<span class="call">frame</span>(width: leftEyeRectangleWidth, height: leftEyeRectangleHeight).<span class="call">position</span>(leftEyeRectangleOrigin)
        rightEyeRectangle?.<span class="call">fill</span>(<span class="type">Color</span>.<span class="property">clear</span>).<span class="call">border</span>(<span class="type">Color</span>.<span class="property">red</span>, width: <span class="comment">/*@START_MENU_TOKEN@*/</span><span class="number">1</span><span class="comment">/*@END_MENU_TOKEN@*/</span>).<span class="call">frame</span>(width: rightEyeRectangleWidth, height: rightEyeRectangleHeight).<span class="call">position</span>(rightEyeRectangleOrigin)
      }
      <span class="type">Spacer</span>()
    }
    <span class="type">Spacer</span>()
    <span class="type">HStack</span> {
      <span class="type">Button</span>(<span class="string">"Apply Filter"</span>) { <span class="keyword">self</span>.<span class="call">applyFilter</span>() }
      <span class="type">Spacer</span>()
      <span class="type">Button</span>(<span class="string">"Find Faces"</span>) { <span class="keyword">self</span>.<span class="call">boxFaces</span>()  }
    }.<span class="call">padding</span>()
      
  }.<span class="call">onAppear</span>(perform: loadImage)
}
</code></pre><p>Let's talk about the <code>boxFaces()</code> function next. Let me start by saying that the <code>CoreImage</code> face detection isn't <em>perfect</em> - we'll see that in a bit. Also, there is a bit of hoop jumping involved - the need to convert from the <code>CoreImage</code> coordinate system (which has the origin in the LOWER left corner) to the <code>UIView</code>/SwiftUI coordinate system (which has the origin in the TOP left corner) is something we'll deal with below. OK let's dive into this. Start by initializing a <code>CIImage</code> using the <code>uiImage</code> object, make a face detector, and get the faces in the image</p><pre><code><span class="keyword">func</span> boxFaces()
{
  <span class="keyword">let</span> faceImage = <span class="type">CIImage</span>(image: uiImage)
  <span class="keyword">let</span> faceDetector = <span class="type">CIDetector</span>(ofType: <span class="type">CIDetectorTypeFace</span>, context: <span class="keyword">nil</span>, options: [<span class="type">CIDetectorAccuracy</span>: <span class="type">CIDetectorAccuracyHigh</span>])
  <span class="keyword">let</span> faces = faceDetector?.<span class="call">features</span>(in: faceImage!) <span class="keyword">as</span>! [<span class="type">CIFaceFeature</span>]
</code></pre><p><code>CoreImage</code> can detect different things, so we're telling it to detect faces here with <code>CIDetectorTypeFace</code>. The <code>faceDetector</code> can give us features in that <code>faceImage</code> object and return them as an array of <code>CIFaceFeature</code> objects.</p><p>As I mentioned, we have to make a transform to take the coordinates from <code>CoreImage</code> space to SwiftUI space. Since the y-axis is inverted, we'll start with a scale that handles that flip, and then slide the system up by the height of the original image to get that origin back in the upper left hand corner</p><pre><code>   <span class="comment">//define transform to convert from CoreImage coordinate system to UIView/SwiftUI coordinate system</span>
  <span class="keyword">let</span> transformScale = <span class="type">CGAffineTransform</span>(scaleX: <span class="number">1</span>, y: -<span class="number">1</span>)
  <span class="keyword">let</span> transform = transformScale.<span class="call">translatedBy</span>(x: <span class="number">0</span>, y: -faceImage!.extent.<span class="property">size</span>.<span class="property">height</span>)

</code></pre><p>Next, loop through the faces, and for each face, apply the transform to the bounds, so it gets in the right coordinate system. Then initialize the rectangle to show the face, and using the <code>faceBounds</code>, set the <code>width</code>, <code>height</code> and <code>origin</code> properties. Remember here that the <code>origin</code> is the <em>center</em> of the rectangle, but <code>CoreGraphics</code> rectangles have an origin in the upper left. So when calculating the center use the <code>origin</code>, <code>width</code> and <code>height</code> properties accordingly to generate the proper x,y coordinates.</p><pre><code>   <span class="keyword">for</span> face <span class="keyword">in</span> faces {

    <span class="comment">//face detection code</span>
    <span class="keyword">let</span> faceBounds = face.<span class="property">bounds</span>.<span class="call">applying</span>(transform)

    <span class="keyword">self</span>.<span class="property">faceRectangle</span> = <span class="type">Rectangle</span>()
    <span class="keyword">self</span>.<span class="property">faceRectangleWidth</span> = faceBounds.<span class="property">width</span>
    <span class="keyword">self</span>.<span class="property">faceRectangleHeight</span> = faceBounds.<span class="property">height</span>
    <span class="keyword">self</span>.<span class="property">faceRectangleOrigin</span> = <span class="type">CGPoint</span>(x: faceBounds.<span class="property">origin</span>.<span class="property">x</span> + faceBounds.<span class="property">width</span>/<span class="number">2</span>, y: faceBounds.<span class="property">origin</span>.<span class="property">y</span> + faceBounds.<span class="property">height</span>/<span class="number">2</span>)
</code></pre><p>Do a similar process for the eyes, whose positions can be retrieved from the <code>face.leftEyePosition</code> and <code>face.rightEyePosition</code> properties.</p><pre><code>     <span class="comment">//Eye detection code</span>
    <span class="keyword">let</span> leftEyePoint = face.<span class="property">leftEyePosition</span>
    <span class="keyword">let</span> leftEyeBounds = <span class="type">CGRect</span>(x: leftEyePoint.<span class="property">x</span>, y: leftEyePoint.<span class="property">y</span>, width: <span class="number">10</span>, height: <span class="number">10</span>).<span class="call">applying</span>(transform)
    <span class="keyword">self</span>.<span class="property">leftEyeRectangle</span> = <span class="type">Rectangle</span>()
    <span class="keyword">self</span>.<span class="property">leftEyeRectangleWidth</span> = leftEyeBounds.<span class="property">width</span>
    <span class="keyword">self</span>.<span class="property">leftEyeRectangleHeight</span> = leftEyeBounds.<span class="property">height</span>
    <span class="keyword">self</span>.<span class="property">leftEyeRectangleOrigin</span> = leftEyeBounds.<span class="property">origin</span>

    <span class="keyword">let</span> rightEyePoint = face.<span class="property">rightEyePosition</span>
    <span class="keyword">let</span> rightEyeBounds = <span class="type">CGRect</span>(x: rightEyePoint.<span class="property">x</span>, y: rightEyePoint.<span class="property">y</span>, width: <span class="number">10</span>, height: <span class="number">10</span>).<span class="call">applying</span>(transform)
    <span class="keyword">self</span>.<span class="property">rightEyeRectangle</span> = <span class="type">Rectangle</span>()
    <span class="keyword">self</span>.<span class="property">rightEyeRectangleWidth</span> = rightEyeBounds.<span class="property">width</span>
    <span class="keyword">self</span>.<span class="property">rightEyeRectangleHeight</span> = rightEyeBounds.<span class="property">height</span>
    <span class="keyword">self</span>.<span class="property">rightEyeRectangleOrigin</span> = rightEyeBounds.<span class="property">origin</span>
    }
  }
}
</code></pre><p>Note that this process may get a bit more complicated when the image you are displaying is bigger or smaller than the <code>Image</code> view - you have to deal with an additional scaling factor to get the coordinates correct.</p><p>Run this in the simulator or preview canvas and hit the button - and you can see that the face and eyes are identified! The face box is pretty spot on, but the eyes.... well, they aren't exactly right, but they are close (they seem to be about 10 pixels off regardless of which image I use.... I'm guessing this is a bug). Other facial feature detection is possible, and you can even use the <code>Vision</code> framework to detect faces and features in live video (and this framework may improve upon the buginess in detecting the eyes).</p><p><code>CoreImage</code>’s face detection API is pretty powerful, and gives you the data you need to highlight the faces and facial features in your image. If you have any questions about the examples in this video, please post them in the forums.</p><p style="float: left">Previous:  <A HREF="../02-CoreImageFiltersExample/index.html">Core Image Filters Example</A></p><p style="float: right">Next:  <A HREF="../04-MakingCustomControlsWithSwiftUI/index.html" class="nextModule">Making Custom Controls with SwiftUI</A></p></div><footer><p>Generated with ❤️ using <a href="https://github.com/johnsundell/publish">Publish</a></p><p>© 2022-2023 Josh Steele (rsteele3@jhu.edu) <a href="mailto:"(rsteele3@jhu.edu)""></a></p><p>Last updated January 23, 2023 at 4:41 PM</p><p><a href="https://twitter.com/hococoder" target="_blank">My Twitter</a> | <a href="https://github.com/hococoder" target="_blank">My GitHub</a> | <a href="https://ep.jhu.edu" target="_blank">Whiting School EPP</a> | <a href="https://blackboard.jhu.edu" target="_blank">JHU Blackboard</a></p></footer></body></html>